{% extends "base.html" %}
{% load humanize %}
{% load materializecss %}
{% load staticfiles %}
{% block title %} | Ticket ({{ ticket.ticket_type }}): {{ ticket.title }}{% endblock %}
{% block css %}
<style>
    body {
        background: url("{% static 'img/bg-03.png' %}") no-repeat center center fixed;
        background-size: cover;
    }
</style>
{% endblock %}

{% block content %}
<!-- set variable for 'today' -->
{% now "j F Y" as today %}

<div class="row">
    <div class="col s12">
        <div class="card form white-text text-shadow-2">
            <div class="card-content white-text">

                <div class="card-badge-div">
                    <!-- Ticket Status (Open | In Progress | Closed) -->
                    <span class="card-badge card-badge-{% include 'partials/status_color.html' %}">
                        <!-- Ticket Type (Bug vs Feature) -->
                        {% if ticket.ticket_type == "Bug" %}
                        <i class="fas fa-bug fa-lg" aria-hidden="true"></i>
                        {% elif ticket.ticket_type == "Feature" %}
                        <i class="fas fa-magic fa-lg" aria-hidden="true"></i>
                        {% endif %}
                    </span>
                </div>

                <div class="row">
                    <div class="col s12">
                        <!-- TICKET TITLE -->
                        <h4 class="bold center-align">{{ ticket.title }}</h4>
                        <div class="divider {% include 'partials/status_color.html' %}"></div>
                        <div class="row">

                            <!-- TICKET DESCRIPTION -->
                            <div class="col s12 m7 justify">
                                <br>
                                <p class="{% include 'partials/status_color.html' %}-text bold">
                                    {{ ticket.ticket_type|upper }} DETAILS
                                </p>
                                <br>
                                <p class="bold">Ticket Number: #{{ ticket.id }}</pc>
                                <p>{{ ticket.description|linebreaksbr }}</p>
                            </div>

                            <!-- TICKET STATS -->
                            <div class="col s12 m5 center-align">
                                <div class="divider hide-on-med-and-up {% include 'partials/status_color.html' %}">
                                </div>
                                <div class="row bold">

                                    <!-- author -->
                                    <div class="col s6">
                                        <img src="{{ ticket.author.profile.image.url }}" width="85px" height="85px"
                                            alt="{{ ticket.author }}" class="circle white tooltipped"
                                            data-position="bottom" data-tooltip="AUTHOR" lazyload="on">
                                        <br>
                                        {{ ticket.author }}
                                    </div>

                                    <!-- ticket progress ( open | in progress | closed ) -->
                                    <div class="col s6">
                                        <h2 class="{% include 'partials/status_color.html' %}-text">
                                            <i {% if ticket.ticket_status == "Open" %}class="fas fa-hourglass-start tooltipped"
                                            {% elif ticket.ticket_status == "In Progress" %}class="fas fa-tools tooltipped"
                                            {% elif ticket.ticket_status == "Closed" %}class="fas fa-check-circle tooltipped"
                                            {% endif %} data-position="bottom" data-tooltip="STATUS"></i>
                                        </h2>
                                        {{ ticket.ticket_status|upper }}<br>
                                        <small>
                                            {% if ticket.ticket_status == "Closed" %}
                                                {{ ticket.date_edited|naturalday:"j N Y" }}
                                            {% elif ticket.date_created.date|date:"j F Y" == today %}
                                                <span class="new badge amber black-text" data-badge-caption="NEW!"></span>
                                            {% else %}
                                                {{ ticket.date_created|timesince }}
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>

                                <div class="row bold">
                                    <!-- views -->
                                    <div class="col s6">
                                        <span class="{% include 'partials/status_color.html' %}-text">
                                            <h2>
                                                <i class="far fa-eye tooltipped" data-position="bottom"
                                                    data-tooltip="VIEWS"></i>
                                            </h2>
                                        </span>
                                        {{ ticket.views }}
                                    </div>

                                    <!-- upvotes -->
                                    <div class="col s6">
                                        <span class="{% include 'partials/status_color.html' %}-text">
                                            <h2>
                                                <i class="far fa-thumbs-up tooltipped" data-position="bottom"
                                                    data-tooltip="UPVOTES"></i>
                                            </h2>
                                        </span>
                                        {{ ticket.upvotes }}
                                        {% if user.id in voters %}
                                        <i class="fas fa-check fa-lg green-text tooltipped" data-position="top"
                                            data-tooltip="I support this!"></i>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row bold">
                                    <!-- date created -->
                                    <div class="col s6">
                                        <span class="{% include 'partials/status_color.html' %}-text">
                                            <h2>
                                                <i class="far fa-calendar-plus tooltipped" data-position="bottom"
                                                    data-tooltip="DATE CREATED"></i>
                                            </h2>
                                        </span>
                                        {{ ticket.date_created|naturalday:"d E, Y"|upper }}<br>
                                        <small>{{ ticket.date_created|time:"@H:i (T)" }}</small>
                                    </div>

                                    <!-- date last edited -->
                                    <div class="col s6">
                                        {% if ticket.date_created.date != ticket.date_edited.date %}
                                            {% include 'partials/date_edited.html' %}
                                        {% else %}
                                            {% if ticket.date_created.time.hour != ticket.date_edited.time.hour %}
                                                {% include 'partials/date_edited.html' %}
                                            {% else %}
                                                {% if ticket.date_created.time.minute != ticket.date_edited.time.minute %}
                                                    {% include 'partials/date_edited.html' %}
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>

                                {% if ticket.ticket_type == "Feature" and ticket.total_donations >= 100 %}
                                <div class="divider {% include 'partials/status_color.html' %}"></div>
                                <div class="row bold">
                                    <!-- donations gross total -->
                                    <div class="col s6">
                                        <span class="{% include 'partials/status_color.html' %}-text">
                                            <h2>
                                                <i class="fas fa-hand-holding-usd tooltipped" data-position="bottom"
                                                    data-tooltip="DONATIONS"></i>
                                            </h2>
                                        </span>
                                        &euro;{{ ticket.total_donations }}
                                    </div>

                                    <!-- donations percentage -->
                                    <div class="col s6">
                                        <span class="{% include 'partials/status_color.html' %}-text">
                                            <h2>
                                                <i class="fas fa-trophy tooltipped" data-position="bottom" data-tooltip="GOAL"></i>
                                            </h2>
                                        </span>
                                        {{ ticket.total_donations }}%
                                    </div>
                                </div>
                                {% endif %}

                                <!-- edit | delete (only available if status is not 'Closed') -->
                                {% if ticket.ticket_status != "Closed" %}
                                    {% if user.id == ticket.author.id or user.is_superuser %}
                                    <div class="divider {% include 'partials/status_color.html' %}"></div>
                                    <div class="row">
                                        <!-- Edit (if permitted) -->
                                        <a href="{% url 'tickets_edit' ticket.id %}" class="white-text">
                                            <div class="col s6 blue">
                                                <h4><i class="far fas fa-edit"></i></h4>
                                                <h6 class="bold">EDIT<br>{{ ticket.ticket_type|upper }}</h6>
                                            </div>
                                        </a>
                                        <!-- Delete (if permitted) -->
                                        <a href="#modal-tickets-delete" class="modal-trigger white-text">
                                            <div class="col s6 red">
                                                <h4><i class="far fas fa-trash-alt"></i></h4>
                                                <h6 class="bold">DELETE<br>{{ ticket.ticket_type|upper }}</h6>
                                            </div>
                                        </a>
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- UPVOTE OPTION -->
            {% include "partials/upvotes.html" %}

        </div>

        <br><br>

        <!-- COMMENTS -->


        {% include "partials/comments.html" %}



    </div>

    <div class="col s12 center-align">
        <div class="divider {% include 'partials/status_color.html' %}"></div>
        <!-- back -->
        <span class="bold text-shadow-2">
            <a href="{% url 'tickets_view_all' %}"
                class="btn btn-large {% include 'partials/status_color.html' %}">
                Back
                <i class="fas fa-chevron-circle-left left" aria-hidden="true"></i>
            </a>
        </span>
    </div>
</div>


<!-- DELETE TICKET MODAL -->
<div id="modal-tickets-delete" class="modal white-text">
    <div class="modal-content center-align bold">
        <h4 class="green-text">Confirm Deletion</h4>
        <h5>Are you sure you want to delete this {{ ticket.ticket_type }}?</h5>
        <p>This action cannot be undone.</p>
        <a href="{% url 'tickets_delete' ticket.id %}" class="btn green text-shadow-2">
            <i class="far fa-trash-alt right" aria-hidden="true"></i>Yes
        </a>
        <a class="btn modal-close red text-shadow-2">
            <i class="fas fa-reply right"></i>No
        </a>
    </div>
</div>

{% endblock %}

{% block js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    // Slider/Range Values
    defaultVal = $("#id_donation_amount").val();
    $("#btn-pay-span, #total-cost").text(defaultVal);
    $("input[type=range]").on("input", function () {
        $(".thumb .value").trigger("change");
        $("#btn-pay-span, #total-cost").text($(".thumb .value").text());
    });
</script>
<script src="{% static 'js/stripe.js' %}"></script>
{% endblock %}
